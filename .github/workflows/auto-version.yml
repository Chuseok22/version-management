name: Version Management

on:
  workflow_call:
    inputs:
      # í”„ë¡œì íŠ¸ íƒ€ì…
      project_type:
        description: "í”„ë¡œì íŠ¸ íƒ€ì… ì„¤ì • (spring | next | auto) - ê¸°ë³¸: auto"
        required: false
        type: string
        default: "auto"

      # main ì—ì„œë§Œ ì‹¤í–‰ ê°•ì œ
      default_branch:
        description: "ì‹¤í–‰í•  ê¸°ë³¸ ë¸Œëœì¹˜ëª… (ì˜ˆ: main) - ê¸°ë³¸ main"
        required: false
        type: string
        default: "main"

      # ë²„ì „ ì¦ê°€ íŠ¸ë¦¬ê±° ë°©ì‹: ì»¤ë°‹ í•œ ì¤„(subject) íŒ¨í„´ë§Œ í—ˆìš©
      tag_prefix:
        description: "íƒœê·¸ prefix (ì˜ˆ: v) - ê¸°ë³¸: v"
        required: false
        type: string
        default: "v"

      # ë²„ì „ì´ ì—†ëŠ” ê²½ìš° ì´ˆê¸° ë²„ì „ ì„¤ì •
      default_version:
        description: "ì´ˆê¸° ë²„ì „(íƒœê·¸/íŒŒì¼ ëª¨ë‘ ì—†ì„ ë•Œ) - ê¸°ë³¸: 0.0.0"
        required: false
        type: string
        default: "0.0.0"

      # Next.js ìƒìˆ˜ íŒŒì¼ ê²½ë¡œ
      next_constant_path:
        description: "Next.js ë²„ì „ ìƒìˆ˜ ê²½ë¡œ - ê¸°ë³¸: src/constant/version.ts"
        required: false
        type: string
        default: "src/constant/version.ts"

      # Spring Boot application.yml ì˜ version í‚¤ ì¹˜í™˜ (true/false)
      sync_app_yaml:
        description: "Spring application.yml ì˜ version í‚¤ ì¹˜í™˜ (true/false) - ê¸°ë³¸: false"
        required: false
        type: string
        default: "false"

      # ëª¨ë…¸ë ˆí¬ í•˜ìœ„ ì‘ì—…ê²½ë¡œ
      workdir:
        description: "í•˜ìœ„ í´ë” (ì˜ˆ: backend/ ë˜ëŠ” web/). ë¹ˆ ê°’ì´ë©´ ë£¨íŠ¸ê²½ë¡œ - ê¸°ë³¸: ë£¨íŠ¸ê²½ë¡œ"
        required: false
        type: string
        default: ""

      # í›„ì† ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±°
      dispatch_on_bump:
        description: "ë²„ì „ ì¦ê°€ ì‹œ repository_dispatch ì´ë²¤íŠ¸ ì „ì†¡ ì—¬ë¶€ - ê¸°ë³¸: true"
        required: false
        type: string
        default: "true"

      dispatch_event_type:
        description: "repository_dispatch ì´ë²¤íŠ¸ íƒ€ì… - ê¸°ë³¸: version-bumped"
        required: false
        type: string
        default: "version-bumped"

    outputs:
      version_bumped:
        description: "ë²„ì „ ì¦ê°€ ì—¬ë¶€ (true/false)"
        value: ${{ jobs.version.outputs.version_bumped }}

      bump_level:
        description: "major | minor | patch | none"
        value: ${{ jobs.version.outputs.bump_level }}

      new_version:
        description: "ì¦ê°€ í›„ ë²„ì „ (ì˜ˆ: 1.0.3)"
        value: ${{ jobs.version.outputs.new_version }}

      new_tag:
        description: "ì¦ê°€ í›„ íƒœê·¸ (ì˜ˆ: v1.0.3)"
        value: ${{ jobs.version.outputs.new_tag }}

permissions:
  contents: write
  actions: read

concurrency:
  group: version-management-${{ github.repository }}-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  version:
    name: Version Bump (central)
    runs-on: ubuntu-latest
    outputs:
      version_bumped: ${{ steps.compute.outputs.version_bumped }} # ë²„ì „ ì¦ê°€ ì—¬ë¶€ (true/false)
      bump_level: ${{ steps.compute.outputs.bump_level }}
      new_version: ${{ steps.compute.outputs.new_version }}
      new_tag: ${{ steps.compute.outputs.new_tag }}

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # ì»¤ë°‹ ê²€ì‚¬ + ë²„ì „ ê³„ì‚° (main & íŒ¨í„´ ê°ì§€)
      - id: compute
        shell: bash
        env:
          INPUT_PROJECT_TYPE: ${{ inputs.project_type }}
          INPUT_DEFAULT_BRANCH: ${{ inputs.default_branch }}
          INPUT_TAG_PREFIX: ${{ inputs.tag_prefix }}
          INPUT_DEFAULT_VERSION: ${{ inputs.default_version }}
          INPUT_WORKDIR: ${{ inputs.workdir }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_ACTOR: ${{ github.actor }}
        run: node "${{ github.action_path }}/../actions/version-bump/scripts/compute-bump.mjs"

      # ë²„ì „ ì¦ê°€ê°€ ì—†ìœ¼ë©´(ì¼ë°˜ ì»¤ë°‹) - ì„±ê³µ ì¢…ë£Œ
      - name: ğŸ“ ë²„ì „ ì¦ê°€ ì—†ìŒ(ì¼ë°˜ ì»¤ë°‹) - ì„±ê³µ ì¢…ë£Œ
        if: ${{ steps.compute.outputs.version_bumped != 'true'}}
        run: |
          echo "ì¼ë°˜ ì»¤ë°‹ì…ë‹ˆë‹¤. ë²„ì „ ë³€ê²½ ì—†ìŒ. (ì„±ê³µ ì¢…ë£Œ)
          exit 0

      # íŒŒì¼ ë™ê¸°í™” (build.gradle / package.json / application.yml / version.ts)
      - name: íŒŒì¼ ë²„ì „ ë™ê¸°í™”
        shell: bash
        env:
          PROJECT_TYPE: ${{ steps.compute.outputs.project_type }}
          NEW_VERSION: ${{ steps.compute.outputs.new_version }}
          INPUT_NEXT_CONSTANTS_PATH: ${{ inputs.next_constant_path }}
          INPUT_SYNC_APP_YAML: ${{ inputs.sync_app_yaml }}
          INPUT_WORKDIR: ${{ inputs.workdir }}
        run: node "${{ github.action_path }}/../actions/version-bump/scripts/sync-files.mjs"

      # CHANGELOG.md íŒŒì¼ ì—…ë°ì´íŠ¸
      - name: CHANGELOG.md íŒŒì¼ ì—…ë°ì´íŠ¸
        shell: bash
        env:
          NEW_VERSION: ${{ steps.compute.outputs.new_version }}
          BUMP_LEVEL: ${{ steps.compute.outputs.bump_level }}
          COMMIT_SUBJECT: ${{ steps.compute.outputs.commit_subject }}
          COMMIT_SHA: ${{ steps.compute.outputs.commit_sha }}
          TZ: Asia/Seoul
        run: node "${{ github.action_path }}/../actions/version-bump/scripts/update-changelog.mjs"

      # íƒœê·¸ ìƒì„± í›„ í‘¸ì‹œ + ë¦´ë¦¬ì¦ˆ ì»¤ë°‹ í‘¸ì‹œ
      - name: ìƒˆë¡œìš´ íƒœê·¸ & ë¦´ë¦¬ì¦ˆ ìƒì„±
        shell: bash
        env:
          TAG: ${{ steps.compute.outputs.new_tag }}
          NEW_VERSION: ${{ steps.compute.outputs.new_version }}
          SKIP_TOKEN: "[skip version]"
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: node "${{ github.action_path }}/../actions/version-bump/scripts/create-tag.mjs"